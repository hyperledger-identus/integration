# Release Integration Workflow
#
# Manually triggered workflow for testing release versions
# Similar to integration.yml but specifically for release components
# Handles both draft and final releases
#
# Usage: Actions → Release Integration → Run workflow → Enter version

name: Release Integration

permissions:
  contents: read

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (e.g., 1.0.0 or 1.0.0-draft)'
        required: true
        type: string

concurrency:
  group: 'integration-lock'
  cancel-in-progress: false

jobs:
  main:
    name: "Trigger 'release' integration"
    runs-on: ubuntu-latest

    outputs:
      env: ${{ steps.components.outputs.env }} # base64 encoded
      sdk-ts: ${{ steps.components.outputs.sdk-ts }}
      sdk-kmp: ${{ steps.components.outputs.sdk-kmp }}
      sdk-swift: ${{ steps.components.outputs.sdk-swift }}

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 20

      - name: Define release environment
        id: components
        env:
          GH_TOKEN: ${{ secrets.IDENTUS_CI }}
          COMPONENT: release
          VERSION: ${{ github.event.inputs.release_version }}
          RUN_ID: ${{ github.run_id }}
        run: |
          npm ci
          npm run environment
          ENV="$(cat env)"
          echo "env=$ENV" >> "$GITHUB_OUTPUT"
          echo "sdk-ts=$(echo $ENV | base64 --decode | jq -r '.runners.["sdk-ts"].enabled')" >> "$GITHUB_OUTPUT"
          echo "sdk-kmp=$(echo $ENV | base64 --decode | jq -r '.runners.["sdk-kmp"].enabled')" >> "$GITHUB_OUTPUT"
          echo "sdk-swift=$(echo $ENV | base64 --decode | jq -r '.runners.["sdk-swift"].enabled')" >> "$GITHUB_OUTPUT"
          echo $ENV | base64 --decode

  cloud-setup:
    needs: main
    name: Cloud setup
    runs-on: ubuntu-latest
    env:
      ENV: ${{ needs.main.outputs.env }}
      CLOUD_SERVICE_TOKEN: ${{ secrets.CLOUD_SERVICE_TOKEN }}
      CLOUD_SERVICE_URL: ${{ secrets.CLOUD_SERVICE_URL }}
      CLOUD_SERVICE_PROJECT: ${{ secrets.CLOUD_SERVICE_PROJECT }}

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 20

      - name: Setup environment
        run: |
          npm ci
          npm run cloud:check
          npm run cloud:setup

  sdk-ts:
    needs: [main, cloud-setup]
    if: needs.main.outputs.sdk-ts  == 'true'
    secrets: inherit
    uses: ./.github/workflows/sdk-ts.yml
    with:
      ENV: ${{ needs.main.outputs.env }}

  sdk-kmp:
    needs: [main, cloud-setup]
    if: false # needs.main.outputs.sdk-kmp  == 'true'
    secrets: inherit
    uses: ./.github/workflows/sdk-kmp.yml
    with:
      ENV: ${{ needs.main.outputs.env }}

  sdk-swift:
    needs: [main, cloud-setup]
    if: needs.main.outputs.sdk-swift  == 'true'
    secrets: inherit
    uses: ./.github/workflows/sdk-swift.yml
    with:
      ENV: ${{ needs.main.outputs.env }}

  generate-reports:
    needs: [main, sdk-ts, sdk-kmp, sdk-swift]
    if: always()
    secrets: inherit
    uses: ./.github/workflows/report.yml
    permissions:
      pages: write
      id-token: write
      contents: write
      actions: read
    with:
      env: ${{ needs.main.outputs.env }}
      run-id: ${{ github.run_id }}
      component: release
      sdk-ts: ${{ needs.sdk-ts.result != 'skipped' }}
      sdk-kmp: ${{ needs.sdk-kmp.result != 'skipped' }}
      sdk-swift: ${{ needs.sdk-swift.result != 'skipped' }}
