# Integration Workflow
# 
# This workflow is triggered by repository_dispatch events from other repositories
# when components need integration testing. It:
# 1. Generates environment configuration based on component and version
# 2. Sets up cloud services (agent, mediator, prism-node)
# 3. Runs SDK tests in parallel (sdk-ts, sdk-swift, sdk-kmp)
# 4. Aggregates results and generates Allure reports
# 5. Deploys reports to GitHub Pages
# 6. Sends Slack notifications on failure
#
# Trigger: repository_dispatch with type 'integration'
# Payload: { "component": "<component>", "version": "<version>" }

name: Integration

run-name: "Integrate: ${{ github.event.client_payload.component }}"

# Prevent concurrent runs to avoid resource conflicts
concurrency:
  group: 'integration-lock'
  cancel-in-progress: false

on:
  repository_dispatch:
    types:
      - 'integration'

permissions:
  contents: read
      
jobs:
  # Main job: Generate environment configuration
  # Determines which SDKs to run and creates base64-encoded environment config
  main:
    name: "Trigger '${{ github.event.client_payload.component }}' integration"
    runs-on: ubuntu-latest

    outputs:
      env: ${{ steps.components.outputs.env }} # base64 encoded environment configuration
      sdk-ts: ${{ steps.components.outputs.sdk-ts }} # Whether sdk-ts should run
      sdk-kmp: ${{ steps.components.outputs.sdk-kmp }} # Whether sdk-kmp should run
      sdk-swift: ${{ steps.components.outputs.sdk-swift }} # Whether sdk-swift should run

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 20

      - name: Define runners
        id: components
        env:
          GH_TOKEN: ${{ secrets.IDENTUS_CI }}
          COMPONENT: ${{ github.event.client_payload.component }}
          VERSION: ${{ github.event.client_payload.version }}
          RUN_ID: ${{ github.run_id }}
        run: |
          npm ci
          npm run environment
          ENV="$(cat env)"
          echo "env=$ENV" >> "$GITHUB_OUTPUT"
          echo "sdk-ts=$(echo $ENV | base64 --decode | jq -r '.runners.["sdk-ts"].enabled')" >> "$GITHUB_OUTPUT"
          echo "sdk-kmp=$(echo $ENV | base64 --decode | jq -r '.runners.["sdk-kmp"].enabled')" >> "$GITHUB_OUTPUT"
          echo "sdk-swift=$(echo $ENV | base64 --decode | jq -r '.runners.["sdk-swift"].enabled')" >> "$GITHUB_OUTPUT"
          echo $ENV | base64 --decode

  # Cloud setup: Deploy cloud services (agent, mediator, prism-node)
  # Uses the environment configuration to determine service versions
  cloud-setup:
    needs: main
    name: Cloud setup
    runs-on: ubuntu-latest
    env:
      ENV: ${{ needs.main.outputs.env }}
      CLOUD_SERVICE_TOKEN: ${{ secrets.CLOUD_SERVICE_TOKEN }}
      CLOUD_SERVICE_URL: ${{ secrets.CLOUD_SERVICE_URL }}
      CLOUD_SERVICE_PROJECT: ${{ secrets.CLOUD_SERVICE_PROJECT }}

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 20

      - name: Setup environment
        run: |
          npm ci
          npm run cloud:check
          npm run cloud:setup

  # SDK runners: Execute tests for each enabled SDK
  # These run in parallel after cloud setup completes
  sdk-ts:
    needs: [main, cloud-setup]
    if: needs.main.outputs.sdk-ts  == 'true'
    secrets: inherit
    uses: ./.github/workflows/sdk-ts.yml
    with:
      ENV: ${{ needs.main.outputs.env }}

  # Note: sdk-kmp is currently disabled due to SDK being broken
  # See src/test-runner/kotlin.ts for details
  sdk-kmp:
    needs: [main, cloud-setup]
    if: false # needs.main.outputs.sdk-kmp  == 'true' (disabled)
    secrets: inherit
    uses: ./.github/workflows/sdk-kmp.yml
    with:
      ENV: ${{ needs.main.outputs.env }}

  sdk-swift:
    needs: [main, cloud-setup]
    if: needs.main.outputs.sdk-swift  == 'true'
    secrets: inherit
    uses: ./.github/workflows/sdk-swift.yml
    with:
      ENV: ${{ needs.main.outputs.env }}

  # Report generation: Aggregates test results and generates Allure reports
  # Runs even if some SDK tests fail (if: always()) to ensure reports are generated
  generate-reports:
    needs: [main, sdk-ts, sdk-kmp, sdk-swift]
    if: always() # Run even if SDK tests fail
    secrets: inherit
    uses: ./.github/workflows/report.yml
    permissions:
      pages: write
      id-token: write
      contents: write
      actions: read
    with:
      env: ${{ needs.main.outputs.env }}
      run-id: ${{ github.run_id }}
      component: ${{ github.event.client_payload.component }}
      sdk-ts: ${{ needs.sdk-ts.result != 'skipped' }}
      sdk-kmp: ${{ needs.sdk-kmp.result != 'skipped' }}
      sdk-swift: ${{ needs.sdk-swift.result != 'skipped' }}
